name: Bump NGINX mainline version

on:
  workflow_dispatch:
  schedule:
    - cron: '10 5 * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-nginx:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Determine latest NGINX mainline from CHANGES
        id: latest
        shell: bash
        run: |
          set -euo pipefail
          LATEST="$(curl -fsSL https://nginx.org/en/CHANGES \
            | grep -oE 'Changes with nginx [0-9]+\.[0-9]+\.[0-9]+' \
            | awk '{print $4}' \
            | awk -F. '{ if ($2 % 2 == 1) { print; exit } }')"
          echo "latest=${LATEST}" >> "$GITHUB_OUTPUT"

      - name: Read current nginxver from build.sh
        id: current
        shell: bash
        run: |
          set -euo pipefail
          CURR="$(grep -oE 'nginxver=[0-9]+\.[0-9]+\.[0-9]+' build.sh | head -n1 | cut -d= -f2)"
          echo "current=${CURR}" >> "$GITHUB_OUTPUT"

      - name: Update build.sh if needed
        if: steps.latest.outputs.latest != steps.current.outputs.current
        shell: bash
        run: |
          set -euo pipefail
          sed -i "s/nginxver=${{ steps.current.outputs.current }}/nginxver=${{ steps.latest.outputs.latest }}/" build.sh
          # Sanity-check the tarball exists
          curl -fsI "https://nginx.org/download/nginx-${{ steps.latest.outputs.latest }}.tar.gz" > /dev/null
          echo "Updated build.sh to ${{ steps.latest.outputs.latest }}"

      - name: Create PR
        if: steps.latest.outputs.latest != steps.current.outputs.current
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "[chore] Bump NGINX mainline from ${{ steps.current.outputs.current }} to ${{ steps.latest.outputs.latest }}"
          title: "Bump NGINX mainline to ${{ steps.latest.outputs.latest }}"
          body: |
            Automated update: latest **mainline** detected from the official CHANGES log.
            - Old: ${{ steps.current.outputs.current }}
            - New: ${{ steps.latest.outputs.latest }}

            Source: https://nginx.org/en/CHANGES
          branch: chore/bump-nginx-${{ steps.latest.outputs.latest }}
          labels: |
            dependencies
            nginx
